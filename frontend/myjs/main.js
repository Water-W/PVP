// example dump data
var data_dump = [
    {
        "From": "127.0.0.1:47720",
        "Reply": {
            "Node": {
                "ID": "QmQdb1MdzB7Gpjczx2t6ytXMz6ZgygXGmcocdHZ8i9y958",
                "Protocols": {
                    "": {
                        "RateIn": 55.25807984448075,
                        "RateOut": 27.97877460480713,
                        "TotalIn": 102895316,
                        "TotalOut": 52929950
                    },
                    "/fastboot/0.0.1": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 0,
                        "TotalOut": 350
                    },
                    "/ipfs/id/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 12367,
                        "TotalOut": 62032
                    },
                    "/ipfs/id/push/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 9554906,
                        "TotalOut": 159356
                    },
                    "/ipfs/kad/1.0.0": {
                        "RateIn": 2.469727125101893e-9,
                        "RateOut": 2.189660221740354e-9,
                        "TotalIn": 84868326,
                        "TotalOut": 117561493
                    },
                    "/ipfs/lan/kad/1.0.0": {
                        "RateIn": 9.409332202854975e-10,
                        "RateOut": 7.153025724365561e-10,
                        "TotalIn": 120802629,
                        "TotalOut": 111594218
                    },
                    "/libp2p/autonat/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 481880,
                        "TotalOut": 466829
                    },
                    "/meshsub/1.1.0": {
                        "RateIn": 40.21808634849647,
                        "RateOut": 44.06456407662479,
                        "TotalIn": 3640700864,
                        "TotalOut": 3646446095
                    },
                    "/p2p/id/delta/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 338451,
                        "TotalOut": 219764
                    },
                    "/sync/getallledgers": {
                        "RateIn": 13.989390521757485,
                        "RateOut": 60.853836709626606,
                        "TotalIn": 117376453,
                        "TotalOut": 143580887
                    },
                    "/sync/getgenesis": {
                        "RateIn": 9.792571111646772,
                        "RateOut": 12.590448572111491,
                        "TotalIn": 13580770,
                        "TotalOut": 14680348
                    },
                    "/topic-wires/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 36293,
                        "TotalOut": 27386
                    }
                }
            },
            "Links": {
                "12D3KooWEbb8qwmvLWWdX6XT6CTj8wJ3CPksvrFAgJ6aLYR4LAFP": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 10152
                },
                "12D3KooWG8kB6jSLA1UyQkb5CXPuKTeNgb5iV3azeQtjYN77KKmH": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 7308
                },
                "12D3KooWHYmLEvtocH54uvL2YvoGkXLfXN95oeiLfFdNLDKrwYgH": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 10620
                },
                "12D3KooWKE9inmFvteFojKHkNVWeEgEAnThB47qVqifcPZHxjmzs": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 10260
                },
                "12D3KooWPWfWnHZoGsVMwhY1GHe5BvVw53CV6fsJDebJUPSRDUPo": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 11196
                },
                "QmPBjhjebkTGgu6HhbXWDKYsp8UHMd2aqKkwnx7ePaGof2": {
                    "RateIn": 3.6971964436848124,
                    "RateOut": 4.78618103664332,
                    "TotalIn": 484413668,
                    "TotalOut": 496619102
                },
                "QmQ5gcoWtjSQQKG9Pa7saH8aXXvD8Dgcwr9bhhF1Q5pPtT": {
                    "RateIn": 3.6971990003154964,
                    "RateOut": 4.6388588993743065,
                    "TotalIn": 489744435,
                    "TotalOut": 468811470
                },
                "QmSoz4S77ZNrVLoGUL2CWWLNyRYta5BugoLAnCyaKNKCC4": {
                    "RateIn": 7.253409885771596,
                    "RateOut": 9.202138353936366,
                    "TotalIn": 482258613,
                    "TotalOut": 484869086
                },
                "QmSzmMQqC7uP8YDACKVBTQKarGticVC2iZLhmdecLarJXZ": {
                    "RateIn": 7.2534098856545395,
                    "RateOut": 6.389290719733717,
                    "TotalIn": 489071141,
                    "TotalOut": 487082004
                },
                "QmX6ZnrUGhTdEfAMQYjLx3CwWexdozSXcXY8GdsEUPVZJY": {
                    "RateIn": 4.178490367970922,
                    "RateOut": 5.403770585430248,
                    "TotalIn": 498640082,
                    "TotalOut": 499120145
                },
                "QmYom65TusPYoE522ZEsfW8zJp2zAvoms66jQvkmvDUTwr": {
                    "RateIn": 3.706011256737523,
                    "RateOut": 4.650166661723141,
                    "TotalIn": 483190898,
                    "TotalOut": 500870560
                },
                "QmagfSwUdwDtvuDtM2GMSrNPiwgy464uD5xbpgs5AU1Jg9": {
                    "RateIn": 3.5498241393436185,
                    "RateOut": 4.638858899222355,
                    "TotalIn": 503450499,
                    "TotalOut": 497091033
                },
                "Qmb7vL2Wo2o6fWPdiTHtGE3sK1bvvGokPRBjK4x5SJj6dM": {
                    "RateIn": 82.21657559231804,
                    "RateOut": 101.12819214727719,
                    "TotalIn": 160217891,
                    "TotalOut": 162320527
                },
                "Qmc6ic4exyYH8tsXTCUnhsmHjPLbmVayZkXEyumB4wF7KE": {
                    "RateIn": 3.7060112567457226,
                    "RateOut": 4.650166661699019,
                    "TotalIn": 499661028,
                    "TotalOut": 490895245
                }
            },
            "ErrMessage": ""
        }
    }
]
let mm = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59", "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73", "74", "75", "76", "77", "78", "79", "80", "81", "82", "83", "84", "85", "86", "87", "88", "89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99", "100", "101", "102", "103", "104", "105", "106", "107", "108", "109"]

var width = $("#graphic").width(),
    height = $("#graphic").height();
let forceWidth = width
let forceHeight = height
let aWidth = $(".overviewpanel").width();
let aHeight = $(".overviewpanel").height();

console.log('awidth', aWidth)

const info = document.createElement("div");
info.setAttribute("class", "info-panel");

infopanel = d3.select(".info-panel")
    .style("position", "fixed")


var charge = -45,
    circleW = 8,
    circleWbig = 15,
    strokewidth = 2//正常stroke-width

//颜色
const palette = {
    lightgray: "#D9DEDE",
    gray: "#C3C8C8",
    mediumgray: "#536870",
    orange: "#BD3613",
    purple: "#595AB7",
    yellowgreen: "#738A05",
};

try {
    request = new XMLHttpRequest();
}
catch (e) {
    try {
        request = new ActiveXObject();
    }
    catch (e) {
        alert("Your brower does not support XMLHTTP!");
    }
}

function geturl() {
    //http://39.104.200.8:18010/dump
    var url = "http://localhost:18010/dump";
    request.open("GET", url, false);
    request.send(null);
    var netdata1 = request.responseText
    var netdata = netdata1

    netdata = eval("(" + netdata + ")");
    console.log(netdata)
    dealdata(netdata)
}
function getquery() {
    var url = 'http://localhost:18010/query';
    var myhttpRequest = new XMLHttpRequest();
    myhttpRequest.open('GET', url, false);//设置你的请求方式
    myhttpRequest.send();
    var netdata = myhttpRequest.responseText
    netdata = eval("(" + netdata + ")")
    console.log("查询获得数据")
    console.log('123', d3.group(netdata, (d) => d._time))
    return dealdata(netdata)
}


// 数据先拿到一个函数里安装时间分片，然后
// 把分好片的数据放入dealdata中处理，处理成links和nodes，然后放入展示
// 同时存放在time -> nodes 、links的映射中


// 日期到数据的映射
var time_data = []
var map_node = new Map();//节点名字到id映射
let nodeNum = 0 //
let links = []
let nodes = [] //当前状态下的所有节点
// 处理同一个时间所有worker传来的数据
function dealdata(netdata) {
    // 返回值 0表示节点不存在，非零表示已经存在
    function pushNode(nodename) {
        if (map_node.has(nodename)) {
            // 返回这个元素
            return 1
        } else {
            map_node.set(nodename, nodeNum)
            nodeNum++
            return 0
        }
    }
    // 处理每个worker返回的结果。
    if (netdata[0] === null) {
        // alert("dump 没有数据")
        console.log("dump没有数据")
        return
    }
    console.log("dump有数据。")


    for (var i = 0; i < netdata.length; i += 4) {
        if (netdata[i].kind === 'edge') {
            // 创建node,以便下面edges压入id
            if (pushNode(netdata[i].from) === 0) {
                nodes.push({
                    id: nodeNum - 1,
                    name: netdata[i].from,
                    target: []
                })
            }
            if (pushNode(netdata[i].to) === 0) {
                nodes.push({
                    id: nodeNum - 1,
                    name: netdata[i].to,
                    target: []
                })
            }
            let from_id = map_node.get(netdata[i].from)
            let to_id = map_node.get(netdata[i].to)
            links.push({
                'from': netdata[i].from,
                'to': netdata[i].to,
                'source': from_id,
                'target': to_id,
                'RateIn': netdata[i]._value,
                'RateOut': netdata[i + 1]._value,
                'TotalIn': netdata[i + 2]._value,
                'TotalOut': netdata[i + 3]._value
            })
            nodes[from_id].target.push(to_id)
        }
        if (netdata[i].kind === 'node') {
            if (netdata[i].protocol === 'other') {
                // 对每个协议，往协议所在的node中添加protocol
                let x = 0
                if (pushNode(netdata[i].nodename) === 0) {
                    nodes.push({
                        id: nodeNum - 1,
                        name: netdata[i].to,
                        target: []
                    })
                    x = nodeNum - 1
                } else {
                    x = map_node.get(netdata[i].nodename)
                }
                if (nodes[x].protocols === undefined) {
                    nodes[x].protocols = []
                }
                nodes[x].protocols.push({
                    'name': netdata[i].name,
                    'RateIn': netdata[i]._value,
                    'RateOut': netdata[i + 1]._value,
                    'TotalIn': netdata[i + 2]._value,
                    'TotalOut': netdata[i + 3]._value
                })
            }
            if (netdata[i].protocol === 'total') {
                let thisnodeid = map_node.get(netdata[i].name)
                nodes[thisnodeid].RateIn = netdata[i]._value
                nodes[thisnodeid].RateOut = netdata[i + 1]._value
                nodes[thisnodeid].TotalIn = netdata[i + 2]._value
                nodes[thisnodeid].TotalOut = netdata[i + 3]._value
            }
        }
    }
    return { "nodes": nodes, "links": links }
}
let ook = getquery()
console.log(ook)

let drag = simulation => {

    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }

    return d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
}
var simulation
function overnode(event, node) {
    //重置
    d3.selectAll('.node')
        .attr('r', circleW)
    d3.selectAll('.line')
        .attr('stroke', palette.lightgray)
        .attr('stroke-width', 2)

    // Hightlight the nodes that the current node connects to
    // for (let i = 0; i < node.target.length; i++) {
    //   d3.select('#node_' + d.target[i]).select('text')
    //     .attr('font-size', '14')
    //     .attr('font-weight', 'bold')
    // }
    let nodeid = node.id
    // Node
    // link connect to this node is orange
    // link connect from this node to other is purple
    for (let x = 0; x < links.length; x++) {
        // 高亮我连出去的node
        if (links[x].source === nodeid) {
            d3.select('#node_' + links[x].target)
                .attr('r', circleWbig)
        }
        if (links[x].target === nodeid) {
            d3.select('#node_' + links[x].source)
                .attr('r', circleWbig)
        }
    }
    //高亮我
    d3.select("#node_" + nodeid)
        .attr('r', circleWbig)

    // Link
    // Highlight the connections to this node高亮到我的边
    d3.selectAll('.to_' + nodeid)
        .attr('stroke', palette.orange)
        .attr('stroke-width', 3)

    // Highlight the connections from this node高亮从我出去的边
    d3.selectAll('.from_' + nodeid)
        .attr('stroke', palette.purple)
        .attr('stroke-width', 3)

    // When mousing over a node, 
    // make it more repulsive so it stands out 让他排斥周围的节点而突出
    // console.log('over', node)
    function strength(node2, id) {
        // console.log("node",node,"id",id)
        if (id != nodeid) {
            // Make the nodes connected to more repulsive
            for (let i = 0; i < node.target.length; i++) {
                if (id === node.target[i]) {
                    return charge * 8
                }
            }
            // Make the nodes connected from more repulsive
            for (let x = 0; x < links.length; x++) {
                if (links[x].source === id) {
                    if (links[x].target === nodeid) {
                        return charge * 8
                    }
                }
            }
            // 不相关的节点保持原来的样子
            return charge * 2;
        } else {
            // Make the selected node more repulsive
            return charge * 10;
        }
    }
    simulation.force("charge", d3.forceManyBody().strength(strength));
    simulation.restart();
}
function buildforce(nodess, linkss) {

    nodes = nodess
    links = linkss
    // links nodes
    simulation = d3.forceSimulation(nodes)
        .force("charge", d3.forceManyBody().strength(-75))
        .force("link", d3.forceLink(links))
        .force("center", d3.forceCenter(forceWidth / 2, forceHeight / 2));

    var fdGraph = d3.select('#graphic svg')
        .attr('viewBox', [0, 0, forceWidth, forceHeight])


    const link = fdGraph.append("g")
        .attr('stroke', palette.gray)
        .attr("stroke-opacity", 0.6)
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", 2)//d => Math.sqrt(d.value))
        .attr('class', function (d, i) {
            // Add classes to lines to identify their from's and to's

            // console.log("line",d)
            var theClass = 'from_' + d.source.id + ' line ';
            if (d.target !== undefined) {
                theClass += 'to_' + d.target.id
            }
            // line_1 line to_2 (ps:这里表示分别属于三个类，line1、line、to_2)
            return theClass
        })
    // .on('mouseover', console.log)

    // Create the SVG circles for the nodes
    function overnode(event, node) {
        //重置
        d3.selectAll('.node')
            .attr('r', circleW)
        d3.selectAll('.line')
            .attr('stroke', palette.lightgray)
            .attr('stroke-width', 2)

        // Hightlight the nodes that the current node connects to
        // for (let i = 0; i < node.target.length; i++) {
        //   d3.select('#node_' + d.target[i]).select('text')
        //     .attr('font-size', '14')
        //     .attr('font-weight', 'bold')
        // }
        let nodeid = node.id
        // Node
        // link connect to this node is orange
        // link connect from this node to other is purple
        for (let x = 0; x < links.length; x++) {
            // 高亮我连出去的node
            if (links[x].source === nodeid) {
                d3.select('#node_' + links[x].target)
                    .attr('r', circleWbig)
            }
            if (links[x].target === nodeid) {
                d3.select('#node_' + links[x].source)
                    .attr('r', circleWbig)
            }
        }
        //高亮我
        d3.select("#node_" + nodeid)
            .attr('r', circleWbig)

        // Link
        // Highlight the connections to this node高亮到我的边
        d3.selectAll('.to_' + nodeid)
            .attr('stroke', palette.orange)
            .attr('stroke-width', 3)

        // Highlight the connections from this node高亮从我出去的边
        d3.selectAll('.from_' + nodeid)
            .attr('stroke', palette.purple)
            .attr('stroke-width', 3)

        // When mousing over a node, 
        // make it more repulsive so it stands out 让他排斥周围的节点而突出
        // console.log('over', node)
        function strength(node2, id) {
            // console.log("node",node,"id",id)
            if (id != nodeid) {
                // Make the nodes connected to more repulsive
                for (let i = 0; i < node.target.length; i++) {
                    if (id === node.target[i]) {
                        return charge * 8
                    }
                }
                // Make the nodes connected from more repulsive
                for (let x = 0; x < links.length; x++) {
                    if (links[x].source === id) {
                        if (links[x].target === nodeid) {
                            return charge * 8
                        }
                    }
                }
                // 不相关的节点保持原来的样子
                return charge * 2;
            } else {
                // Make the selected node more repulsive
                return charge * 10;
            }
        }
        simulation.force("charge", d3.forceManyBody().strength(strength));
        simulation.restart();
    }
    const node = fdGraph.append("g")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr('r', circleW)
        .attr('class', 'node')
        .attr('id', function (d) { return "node_" + d.id })
        .attr('fill', function (d, i) {
            // Color 1/3 of the nodes each color
            // Depending on the data, this can be made more meaningful
            // 可以根据节点的压力来改变颜色。
            if (i < (15 / 3)) {
                return palette.orange
            } else if (i < (15 - (15 / 3))) {
                return palette.purple
            }
            return palette.yellowgreen
        })
        .on('mouseover', overnode)
        .on('click', function (event, node) {
            console.log('click', node)
            //先清空 infopanel todo

            // < div class="dropdown" >
            // <span>鼠标移动到我这！</span>
            // <div class="dropdown-content">
            // <p>菜鸟教程</p>
            // <p>www.runoob.com</p>
            // </div>
            // </div >
            console.log(node)
            console.log(nodes[node.id])
            let curdropdown = d3.select('.infopanel').selectAll('.dropdown')
                .data(nodes[node.id].protocols)
                .enter()
                .append('div')
                .attr('class', 'dropdown');

            let myp = curdropdown.html((d => `<p> ${d.name}</p><div class='dropdown-content'><p>RateIn:${d.RateIn}</p><p>RateOut:${d.RateOut}</p><p>TotalIN:${d.TotalIn}</p><p>TotalOut:${d.TotalOut}</p></div>`));
            // myp.append('p').text();
            // curdropdown.append('p').text();

        })
        .call(drag(simulation));

    //鼠标悬停时候显示
    node.append("title")
        .text(d => d.name);

    node.append('text')
        .text(function (d) {
            return d.name
        })
        .attr('font-size', '12')

    simulation.on("tick", () => {
        // Move the nodes base on charge and gravity
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
    });

    // 聚焦在34号的方法如下
    // overnode(null, nodes[34])
}

buildforce(ook.nodes, ook.links)


$(document).click(function (e) {
    let line_class = $('line');
    let node_class = $('circle');
    let search = $('.searchBtn');
    if (!line_class.is(e.target) && line_class.has(e.target).length === 0) {
        if (!node_class.is(e.target) && node_class.has(e.target).length === 0) {
            if(!search.is(e.target) && search.has(e.target).length === 0){
            d3.selectAll(".line")
                .attr('stroke', palette.lightgray)
                .attr('stroke-width', strokewidth)
            d3.selectAll('.node')
                .attr('r', circleW)
            simulation.force("charge", d3.forceManyBody().strength(-75));
            simulation.restart();
            console.log("点击空白")
            // lock_click = 0;
            }
        }
    }
});

d3.select(".searchBtn")
    .on("click", function (e) {
        let ee = document.getElementById("okk").value;
        console.log('lookme', ee)
        let el = d3.select("#node_" + ee)
        console.log(el)
        console.log(nodes[ee])
    })



function buildBarChart(data) {
    // let delay = 250;
    let yearStep = 1;
    let yearMin = d3.min(data, (d) => d.year);//1841 
    let yearMax = d3.max(data, (d) => d.year);//2019
    let width = aWidth;
    let height = aHeight;
    console.log(aWidth, aHeight)
    let margin = { top: 20, right: 40, bottom: 30, left: 20 };
    // console.log('123', Array.from(d3.group(data, (d) => d.age).keys()).sort(d3.ascending))
    let x = d3
        .scaleBand()
        .domain(mm)
        .range([width - margin.right, margin.left]);//[w - 30, 0]

    // console.log(x(1),x(10),x(20),x(30),x(40),x(50))

    // console.log(Array.from(d3.group(data, (d) => d.age).keys()).sort(d3.ascending))
    console.log('max value', d3.ticks(...d3.extent(data, (d) => d.age), width / 40))
    let y = d3
        .scaleLinear()
        .domain([0, 3270])
        .range([height - margin.bottom, margin.top]);

    let color = d3.scaleOrdinal(["M", "F"], ["#4e79a7", "#e15759"]);
    let xAxis = (g) =>
        g
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(
                d3
                    .axisBottom(x)
                    // .tickValues(d3.ticks(...d3.extent(data, (d) => d.age), width / 40))
                    .tickValues([0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95])
                    .tickSizeOuter(0)//
            )
            .call((g) =>
                g
                    .append("text")
                    .attr("x", 45)
                    .attr("y", margin.bottom - 8)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "end")
                    // .text("← Age")
                    .text("← Mins")
            );
    let yAxis = (g) =>
        g
            .attr("transform", `translate(${width - margin.right},0)`)
            .call(d3.axisRight(y).ticks(null, "s"))
            .call((g) => g.select(".domain").remove())
            .call((g) =>
                g
                    .append("text")
                    .attr("x", margin.right)
                    .attr("y", 10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "end")
                    // .text("Population ↑")
                    .text("TotalIn ↑")
            );
    let svg = d3
        .select(".overviewpanel svg")
        .attr("viewBox", [0, 0, width, height]);
    // aWidth aHeight
    svg.append("g").call(xAxis);
    svg.append("g").call(yAxis);

    let group = svg.append("g");
    let rect = group.selectAll("rect");
    let group2 = svg.append("g")
    let otherrect = group2.selectAll("rect");

    function update() {
        let year = +$("#year-slider").val();//选择的年份

        // debugger;    x.step()  该函数返回相邻频段起点之间的距离。
        const dx = (x.step() * (year - yearMin)) / yearStep;

        const t = svg.transition().ease(d3.easeLinear).duration(100);
        // debugger;
        rect = rect
            .data(
                data.filter((d) => +d.year === year),
                (d) => `${d.sex}:${d.year - d.age}`
            )//                           ???
            .join(
                (enter) =>
                    // console.log('123')
                    enter
                        .append("rect")
                        .style("mix-blend-mode", "darken")
                        .attr("fill", (d) => color('F'))
                        .attr("x", (d) => x(d.age) + dx)
                        .attr("y", (d) => y(0))
                        .attr("width", x.bandwidth() + 1)
                        .attr("height", 0),
                (update) => update,
                (exit) =>
                    exit.call((rect) =>
                        rect.transition(t).remove().attr("y", y(0)).attr("height", 0)
                    )
            );
        //", "#e15759
        otherrect = otherrect
            .data(
                data.filter((d) => +d.year === year),
                (d) => `${d.sex}:${d.year - d.age}`
            )//                           ???
            .join(
                (enter) =>
                    // console.log('123')
                    enter
                        .append("rect")
                        .style("mix-blend-mode", "darken")
                        .attr("fill", (d) => color('M'))
                        .attr("x", (d) => {
                            // console.log('123',d)
                            return x(d.age) + dx + x.step()
                        })
                        .attr("y", (d) => y(0))
                        .attr("width", x.bandwidth() + 1)
                        .attr("height", 0)
                ,
                (update) => update,
                (exit) =>
                    exit.call((rect) =>
                        rect.transition(t).remove().attr("y", y(0)).attr("height", 0)
                    )
            );
        otherrect
            .transition(t)
            .attr("y", (d) => y(d.value))
            .attr("height", (d) => {
                if (d.age === '0') {
                    console.log('123', d)
                    return 0
                }
                return y(0) - y(d.value)
            });
        rect
            .append("title")
            // .text(d => {
            //   return ""d.
            //   ${d.sex}${year - d.year + d.age}+d.value
            // })
            .html((d) => {
                return `<span>time:-${d.age}</span><span>Value:${d.value}</span>`
            });
        rect
            .transition(t)
            .attr("y", (d) => y(d.value))
            .attr("height", (d) => y(0) - y(d.value));

        group2.transition(t).attr("transform", `translate(${-dx},0)`);

        group.transition(t).attr("transform", `translate(${-dx},0)`);
    }
    $("#year-slider").attr("min", yearMin);
    $("#year-slider").attr("max", yearMax);
    $("#year-slider").val(yearMax);
    $("#year-slider").change(update);
}

d3.csv("./data/icelandic-population.csv").then((data) => {
    // console.log(data);
    buildBarChart(data);
});

