// example dump data
var data_dump = [
    {
        "From": "127.0.0.1:47720",
        "Reply": {
            "Node": {
                "ID": "QmQdb1MdzB7Gpjczx2t6ytXMz6ZgygXGmcocdHZ8i9y958",
                "Protocols": {
                    "": {
                        "RateIn": 55.25807984448075,
                        "RateOut": 27.97877460480713,
                        "TotalIn": 102895316,
                        "TotalOut": 52929950
                    },
                    "/fastboot/0.0.1": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 0,
                        "TotalOut": 350
                    },
                    "/ipfs/id/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 12367,
                        "TotalOut": 62032
                    },
                    "/ipfs/id/push/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 9554906,
                        "TotalOut": 159356
                    },
                    "/ipfs/kad/1.0.0": {
                        "RateIn": 2.469727125101893e-9,
                        "RateOut": 2.189660221740354e-9,
                        "TotalIn": 84868326,
                        "TotalOut": 117561493
                    },
                    "/ipfs/lan/kad/1.0.0": {
                        "RateIn": 9.409332202854975e-10,
                        "RateOut": 7.153025724365561e-10,
                        "TotalIn": 120802629,
                        "TotalOut": 111594218
                    },
                    "/libp2p/autonat/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 481880,
                        "TotalOut": 466829
                    },
                    "/meshsub/1.1.0": {
                        "RateIn": 40.21808634849647,
                        "RateOut": 44.06456407662479,
                        "TotalIn": 3640700864,
                        "TotalOut": 3646446095
                    },
                    "/p2p/id/delta/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 338451,
                        "TotalOut": 219764
                    },
                    "/sync/getallledgers": {
                        "RateIn": 13.989390521757485,
                        "RateOut": 60.853836709626606,
                        "TotalIn": 117376453,
                        "TotalOut": 143580887
                    },
                    "/sync/getgenesis": {
                        "RateIn": 9.792571111646772,
                        "RateOut": 12.590448572111491,
                        "TotalIn": 13580770,
                        "TotalOut": 14680348
                    },
                    "/topic-wires/1.0.0": {
                        "RateIn": 0,
                        "RateOut": 0,
                        "TotalIn": 36293,
                        "TotalOut": 27386
                    }
                }
            },
            "Links": {
                "12D3KooWEbb8qwmvLWWdX6XT6CTj8wJ3CPksvrFAgJ6aLYR4LAFP": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 10152
                },
                "12D3KooWG8kB6jSLA1UyQkb5CXPuKTeNgb5iV3azeQtjYN77KKmH": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 7308
                },
                "12D3KooWHYmLEvtocH54uvL2YvoGkXLfXN95oeiLfFdNLDKrwYgH": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 10620
                },
                "12D3KooWKE9inmFvteFojKHkNVWeEgEAnThB47qVqifcPZHxjmzs": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 10260
                },
                "12D3KooWPWfWnHZoGsVMwhY1GHe5BvVw53CV6fsJDebJUPSRDUPo": {
                    "RateIn": 0,
                    "RateOut": 0,
                    "TotalIn": 0,
                    "TotalOut": 11196
                },
                "QmPBjhjebkTGgu6HhbXWDKYsp8UHMd2aqKkwnx7ePaGof2": {
                    "RateIn": 3.6971964436848124,
                    "RateOut": 4.78618103664332,
                    "TotalIn": 484413668,
                    "TotalOut": 496619102
                },
                "QmQ5gcoWtjSQQKG9Pa7saH8aXXvD8Dgcwr9bhhF1Q5pPtT": {
                    "RateIn": 3.6971990003154964,
                    "RateOut": 4.6388588993743065,
                    "TotalIn": 489744435,
                    "TotalOut": 468811470
                },
                "QmSoz4S77ZNrVLoGUL2CWWLNyRYta5BugoLAnCyaKNKCC4": {
                    "RateIn": 7.253409885771596,
                    "RateOut": 9.202138353936366,
                    "TotalIn": 482258613,
                    "TotalOut": 484869086
                },
                "QmSzmMQqC7uP8YDACKVBTQKarGticVC2iZLhmdecLarJXZ": {
                    "RateIn": 7.2534098856545395,
                    "RateOut": 6.389290719733717,
                    "TotalIn": 489071141,
                    "TotalOut": 487082004
                },
                "QmX6ZnrUGhTdEfAMQYjLx3CwWexdozSXcXY8GdsEUPVZJY": {
                    "RateIn": 4.178490367970922,
                    "RateOut": 5.403770585430248,
                    "TotalIn": 498640082,
                    "TotalOut": 499120145
                },
                "QmYom65TusPYoE522ZEsfW8zJp2zAvoms66jQvkmvDUTwr": {
                    "RateIn": 3.706011256737523,
                    "RateOut": 4.650166661723141,
                    "TotalIn": 483190898,
                    "TotalOut": 500870560
                },
                "QmagfSwUdwDtvuDtM2GMSrNPiwgy464uD5xbpgs5AU1Jg9": {
                    "RateIn": 3.5498241393436185,
                    "RateOut": 4.638858899222355,
                    "TotalIn": 503450499,
                    "TotalOut": 497091033
                },
                "Qmb7vL2Wo2o6fWPdiTHtGE3sK1bvvGokPRBjK4x5SJj6dM": {
                    "RateIn": 82.21657559231804,
                    "RateOut": 101.12819214727719,
                    "TotalIn": 160217891,
                    "TotalOut": 162320527
                },
                "Qmc6ic4exyYH8tsXTCUnhsmHjPLbmVayZkXEyumB4wF7KE": {
                    "RateIn": 3.7060112567457226,
                    "RateOut": 4.650166661699019,
                    "TotalIn": 499661028,
                    "TotalOut": 490895245
                }
            },
            "ErrMessage": ""
        }
    }
]
//

infodict = {}

var width = $("#graphic").width(),
    height = $("#graphic").height();


const info = document.createElement("div");
info.setAttribute("class", "info-panel");

infopanel = d3.select(".info-panel")
    .style("position", "fixed")


console.log(width, height);

var circleWidth = 5,
    harge = -75 * 0.6,
    gravity = 0.1;

var lock_click = 0;

//给node和link编号
var nodeNum = 0
var linkNum = 0

var mylink = []
var mynode = []

var palette = {
    "lightgray": "#D9DEDE",
    "gray": "#C3C8C8",
    "mediumgray": "#536870",
    "orange": "#BD3613",
    "purple": "#595AB7",
    "yellowgreen": "#738A05"
}

// Generate test data， 每个节点随机连接到x个节点，x在0~Maxcon中随机。
let nodes = [];
let numNodes = 100;
let Maxcon = 10 //每个节点的
for (let x = 0; x < numNodes; x++) {
    let targetAry = [];
    let connections = (Math.round(Math.random() * Maxcon));
    for (let y = 0; y < connections; y++) {
        targetAry.push(Math.floor(Math.random() * numNodes))
    }
    nodes.push({
        id: x,
        name: "Node_" + x,
        target: targetAry
    })
}

// Create the links array from the generated data
var links = [];
for (var i = 0; i < nodes.length; i++) {
    if (nodes[i].target !== undefined) {
        for (var j = 0; j < nodes[i].target.length; j++) {
            links.push({
                source: nodes[i],
                target: nodes[nodes[i].target[j]]
            })
        }
    }
}

try {
    request = new XMLHttpRequest();
}
catch (e) {
    try {
        request = new ActiveXObject();
    }
    catch (e) {
        alert("Your brower does not support XMLHTTP!");
    }
}

function geturl() {
    //http://39.104.200.8:18010/dump
    var url = "http://localhost:18010/dump";
    request.open("GET", url, false);
    request.send(null);
    var netdata1 = request.responseText
    var netdata = netdata1

    netdata = eval("(" + netdata + ")");
    console.log(netdata)
    dealdata(netdata)
}
function getquery() {
    var url = 'http://localhost:18010/query';
    var myhttpRequest = new XMLHttpRequest();
    myhttpRequest.open('GET', url, false);//设置你的请求方式
    myhttpRequest.send();
    var netdata = myhttpRequest.responseText
    netdata = eval("(" + netdata + ")")
    console.log("查询获得数据", netdata)
    return dealdata(netdata)
}


// 数据先拿到一个函数里安装时间分片，然后
// 把分好片的数据放入dealdata中处理，处理成links和nodes，然后放入展示
// 同时存放在time -> nodes 、links的映射中


// 日期到数据的映射
var time_data = []

// 处理同一个时间所有worker传来的数据
function dealdata(netdata) {
    // 保存node link 的name 和 id的对应关系
    var map_node = new Map();
    var map_link = new Map();

    // 返回值 0表示节点不存在，非零表示已经存在
    function pushNode(nodename) {
        if (map_node.has(nodename)) {
            // 返回这个元素
            return 1
        } else {
            map_node.set(nodename, nodeNum)
            nodeNum++
        }
        return 0;
    }

    function pushLink(linkname) {
        if (map_link.has(linkname)) {
            // 如果link已存在返回零
            return 1
        } else {
            //如果未存在则设置其编号
            map_link.set(linkname, linkNum)
            linkNum++
        }
        return 0
    }

    // 处理每个worker返回的结果。
    if (netdata[0] === null) {
        // alert("dump 没有数据")
        console.log("dump没有数据")
        return
    }
    console.log("dump有数据。")

    // 保存node link 的name 和 id的对应关系
    let map_node = new Map();
    let map_link = new Map();
    let nodeNum = 0 //一个之间状态下node的编号
    let linkNum = 0
    // 返回值 0表示节点不存在，非零表示已经存在
    function pushNode(nodename) {
        if (map_node.has(nodename)) {
            return 1
        }
        map_node.set(nodename, nodeNum)
        nodeNum++
        return 0;
    }
    function pushLink(linkname) {
        if (map_link.has(linkname)) {
            // 如果link已存在返回零
            return 1
        } else {
            //如果未存在则设置其编号
            map_link.set(linkname, linkNum)
            linkNum++
        }
        return 0
    }

    let edges = []
    let thisnode = new Object()
    let nodes = [] //当前状态下的所有节点
    let protocols = []
    for (var i = 0; i < netdata.length; i += 4) {
        if (netdata[i].kind === 'edge') {
            edges.push({
                from: netdata[i].from,
                to: netdata[i].to,
                source: netdata[i].from,
                target: netdata[i].to,
                RateIn: netdata[i]._value,
                RateOut: netdata[i + 1]._value,
                TotalIn: netdata[i + 2]._value,
                TotalOut: netdata[i + 3]._value
            })
            if (pushNode(netdata[i].from) === 0) {
                nodes.push({
                    id: nodeNum - 1,
                    name: netdata[i].from,
                    target: []
                })
            }
            if (pushNode(netdata[i].to) === 0) {
                nodes.push({
                    id: nodeNum - 1,
                    name: netdata[i].to,
                    target: []
                })
            }
        }
        if (netdata[i].kind === 'node') {
            if (netdata[i].protocol === 'other') {
                // 对每个协议，往协议所在的node中添加protocol
                let x = 0
                if (pushNode(netdata[i].nodename) === 0) {
                    nodes.push({
                        id: nodeNum - 1,
                        name: netdata[i].to,
                        target: []
                    })
                    x = nodeNum - 1
                } else {
                    x = map_node[netdata[i].nodename]
                }
                if(!'protocols' in nodes[x]) {
                    nodes[x].protocols = []
                }
                nodes[x].protocols.push({
                    name: netdata[i].nodename,
                    RateIn: netdata[i]._value,
                    RateOut: netdata[i + 1]._value,
                    TotalIn: netdata[i + 2]._value,
                    TotalOut: netdata[i + 3]._value
                })
            }
            if (netdata[i].protocol === 'total') {
                let thisnodeid = map_node[netdata[i].name]
                nodes[thisnodeid] = {
                    id: thisnodeid,
                    name: netdata[i].name,
                    RateIn = netdata[i]._value,
                    RateOut = netdata[i + 1]._value,
                    TotalIn = netdata[i + 2]._value,
                    TotalOut = netdata[i + 3]._value,
                }
            }
        }
    }
    let res = new Object()
    res.node = nodes
    res.links = edges
    return res
}

let ook = getquery()
console.log(ook)

function dealdealdata(netdata) {


    // 每个记录是本结点加上本节点和别的节点的连接。优先填充本节点的信息，连接到的节点信息之后之后再补充。
    function dealdata(netdata) {
        // 处理每个worker返回的结果。
        for (var i = 0; i < netdata.length; i++) {
            var name_link = Object.keys(netdata[i].Reply.Links)
            console.log(name_link)
            let targetAry = [];
            var thisnodeid = nodeNum
            var thislink = netdata[i].Reply.Links
            var thisnodename = netdata[i].Reply.Node.ID
            var x = pushNode(thisnodename)

            if (x) {
                thisnodeid = x
            } else {
                mynode.push({
                    id: thisnodeid,
                    name: thisnodename,
                })
            }

            for (var j = 0; j < name_link.length; j++) {
                x = pushNode(name_link[j])
                if (x === 0) {
                    mynode.push({
                        id: nodeNum - 1,
                        name: name_link[j],
                        target: []
                    })
                    targetAry.push(nodeNum)
                } else {
                    targetAry.push(x)
                }
                x = pushLink(thisnodename + name_link[j])
                // 如果是新link，则压入mylink中
                if (x === 0) {
                    mylink.push({
                        source: mynode[thisnodeid],
                        target: mynode[nodeNum - 1],
                        RateIn: thislink[name_link[j]].RateIn,
                        RateOut: thislink[name_link[j]].RateOut,
                        TotalIn: thislink[name_link[j]].TotalIn,
                        TotalOut: thislink[name_link[j]].TotalOut
                    })
                }

            }
            mynode[thisnodeid].target = targetAry;
        }
        // 定义自己的node link
        console.log(mynode)
        console.log(mylink)
    }
}

function buildforce(nodess, linkss) {
    // Generate test data， 每个节点随机连接到x个节点，x在0~Maxcon中随机。
    let nodes = [];
    let numNodes = 100;
    let Maxcon = 10 //每个节点的
    for (let x = 0; x < numNodes; x++) {
        let targetAry = [];
        let connections = (Math.round(Math.random() * Maxcon));
        for (let y = 0; y < connections; y++) {
            targetAry.push(Math.floor(Math.random() * numNodes))
        }
        nodes.push({
            id: x,
            name: "node_" + x,
            target: targetAry
        })
    }

    // Create the links array from the generated data
    var links = [];
    for (var i = 0; i < nodes.length; i++) {
        if (nodes[i].target !== undefined) {
            for (var j = 0; j < nodes[i].target.length; j++) {
                links.push({
                    source: i,
                    target: nodes[i].target[j],
                    sourcenode: nodes[i],
                    targetnode: nodes[nodes[i].target[j]]
                })
            }
        }
    }

    // links nodes
    const simulation = d3.forceSimulation(nodes)
        .force("charge", d3.forceManyBody().strength(-45))
        .force("link", d3.forceLink(links))
        .force("center", d3.forceCenter(forceWidth / 2, forceHeight / 2));

    var fdGraph = d3.select('#graphic svg')
        .attr('viewBox', [0, 0, forceWidth, forceHeight])


    const link = fdGraph.append("g")
        .attr('stroke', palette.gray)
        .attr("stroke-opacity", 0.6)
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", d => Math.sqrt(d.value))
        .attr('class', function (d, i) {
            // Add classes to lines to identify their from's and to's
            var theClass = 'from_' + d.sourcenode.id + ' line ';
            if (d.target !== undefined) {
                theClass += 'to_' + d.targetnode.id
            }
            // line_1 line to_2 (ps:这里表示分别属于三个类，line1、line、to_2)
            return theClass
        })
    // .on('mouseover', console.log)

    // Create the SVG circles for the nodes
    function overnode(event, node) {
        //重置
        d3.selectAll('.node')
            .attr('r', 5)
        d3.selectAll('.line')
            .attr('stroke', palette.lightgray)
            .attr('stroke-width', 1)

        // Hightlight the nodes that the current node connects to
        // for (let i = 0; i < node.target.length; i++) {
        //   d3.select('#node_' + d.target[i]).select('text')
        //     .attr('font-size', '14')
        //     .attr('font-weight', 'bold')
        // }
        let nodeid = node.id
        // Node
        // link connect to this node is orange
        // link connect from this node to other is purple
        for (let x = 0; x < links.length; x++) {
            // 高亮我连出去的node
            if (links[x].sourcenode.id === nodeid) {
                d3.select('#node_' + links[x].targetnode.id)
                    .attr('r', 10)
            }
            if (links[x].targetnode.id === nodeid) {
                d3.select('#node_' + links[x].sourcenode.id)
                    .attr('r', 10)
            }
        }
        //高亮我
        d3.select("#node_" + nodeid)
            .attr('r', 10)

        // Link
        // Highlight the connections to this node高亮到我的边
        d3.selectAll('.to_' + nodeid)
            .attr('stroke', palette.orange)
            .attr('stroke-width', 3)

        // Highlight the connections from this node高亮从我出去的边
        d3.selectAll('.from_' + nodeid)
            .attr('stroke', palette.purple)
            .attr('stroke-width', 3)

        // When mousing over a node, 
        // make it more repulsive so it stands out 让他排斥周围的节点而突出
        console.log(node)
        function strength(node2, id) {
            // console.log("node",node,"id",id)
            if (id != nodeid) {
                // Make the nodes connected to more repulsive
                for (let i = 0; i < node.target.length; i++) {
                    if (id === node.target[i]) {
                        return charge * 8
                    }
                }
                // Make the nodes connected from more repulsive
                for (let x = 0; x < links.length; x++) {
                    if (links[x].sourcenode.id === id) {
                        if (links[x].targetnode.id === nodeid) {
                            return charge * 8
                        }
                    }
                }
                // 不相关的节点保持原来的样子
                return charge * 1;
            } else {
                // Make the selected node more repulsive
                return charge * 10;
            }
        }
        simulation.force("charge", d3.forceManyBody().strength(strength));
        simulation.restart();
    }
    const node = fdGraph.append("g")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr('r', circleWidth)
        .attr('class', 'node')
        .attr('id', function (d) { return "node_" + d.id })
        .attr('fill', function (d, i) {
            // Color 1/3 of the nodes each color
            // Depending on the data, this can be made more meaningful
            // 可以根据节点的压力来改变颜色。
            if (i < (numNodes / 3)) {
                return palette.orange
            } else if (i < (numNodes - (numNodes / 3))) {
                return palette.purple
            }
            return palette.yellowgreen
        })
        .on('mouseover', function overnode(event, node) {
            //重置
            d3.selectAll('.node')
                .attr('r', 5)
            d3.selectAll('.line')
                .attr('stroke', palette.lightgray)
                .attr('stroke-width', 1)

            // Hightlight the nodes that the current node connects to
            // for (let i = 0; i < node.target.length; i++) {
            //   d3.select('#node_' + d.target[i]).select('text')
            //     .attr('font-size', '14')
            //     .attr('font-weight', 'bold')
            // }
            let nodeid = node.id
            // Node
            // link connect to this node is orange
            // link connect from this node to other is purple
            for (let x = 0; x < links.length; x++) {
                // 高亮我连出去的node
                if (links[x].sourcenode.id === nodeid) {
                    d3.select('#node_' + links[x].targetnode.id)
                        .attr('r', 10)
                }
                if (links[x].targetnode.id === nodeid) {
                    d3.select('#node_' + links[x].sourcenode.id)
                        .attr('r', 10)
                }
            }
            //高亮我
            d3.select("#node_" + nodeid)
                .attr('r', 10)

            // Link
            // Highlight the connections to this node高亮到我的边
            d3.selectAll('.to_' + nodeid)
                .attr('stroke', palette.orange)
                .attr('stroke-width', 3)

            // Highlight the connections from this node高亮从我出去的边
            d3.selectAll('.from_' + nodeid)
                .attr('stroke', palette.purple)
                .attr('stroke-width', 3)

            // When mousing over a node, 
            // make it more repulsive so it stands out 让他排斥周围的节点而突出
            console.log(node)
            function strength(node2, id) {
                // console.log("node",node,"id",id)
                if (id != nodeid) {
                    // Make the nodes connected to more repulsive
                    for (let i = 0; i < node.target.length; i++) {
                        if (id === node.target[i]) {
                            return charge * 8
                        }
                    }
                    // Make the nodes connected from more repulsive
                    for (let x = 0; x < links.length; x++) {
                        if (links[x].sourcenode.id === id) {
                            if (links[x].targetnode.id === nodeid) {
                                return charge * 8
                            }
                        }
                    }
                    // 不相关的节点保持原来的样子
                    return charge * 1;
                } else {
                    // Make the selected node more repulsive
                    return charge * 10;
                }
            }
            simulation.force("charge", d3.forceManyBody().strength(strength));
            simulation.restart();
        })
        .on('click', function (event, node) { })
        .call(drag(simulation));

    //鼠标悬停时候显示
    node.append("title")
        .text(d => d.id);

    node.append('text')
        .text(function (d) {
            return d.name
        })
        .attr('font-size', '12')

    simulation.on("tick", () => {
        // Move the nodes base on charge and gravity
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
    });

    // 聚焦在34号的方法如下
    // overnode(null, nodes[34])

}

// buildforce()


$(document).click(function (e) {
    // let line_class = $('line');
    // let node_class = $('circle');
    if (!line_class.is(e.target) && line_class.has(e.target).length === 0) {
        if (!node_class.is(e.target) && node_class.has(e.target).length === 0) {
            // d3.selectAll(".line")
            //     .attr('stroke', palette.lightgray)
            //     .attr('stroke-width', 1)
            // d3.selectAll('.node').selectAll('text')
            //     .attr('font-size', '12')
            //     .attr('font-weight', 'normal')
            console.log("点击空白")
            // lock_click = 0;
        }
    }
});

d3.select(".searchBtn")
    .on("click", function (e) {
        let ee = document.getElementById("okk").value;
        console.log(ee)
        let el = document.querySelector("#node_" + ee + " circle")
    })


function node_infopanel(id) {
    var node = data_dump[id].Reply.Node
    d3.select(".infopanel").select("#kind")
        .text("node name:" + node.ID)
    d3.select(".infopanel").select('#data')
        .text("node data:" + node.Protocols)
}

function link_infopanel(id) {
    var link = data_dump[id].Reply.Links
    var kk = 1
    for (var k in link) {
        if (kk <= 3) {
            d3.select(".infopanel").append('p')
                .text("link name:" + k)
            for (var k1 in link[k]) {
                d3.select(".infopanel").append('p')
                    .text(k1 + ":" + link[k][k1])
            }
        }
        kk += 1
    }
}
// node_infopanel(0)
// link_infopanel(0)    